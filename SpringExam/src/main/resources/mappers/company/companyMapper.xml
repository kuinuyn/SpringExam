<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spring.mapper.slight.company.companyMapper">

	<select id="getCompanyInfoSearchYear" resultType="hashMap" parameterType="hashMap">
		<![CDATA[
			SELECT A.YEAR
			 FROM GY_MEMBER A
			 GROUP BY A.YEAR
			 ORDER BY 
			 	A.YEAR DESC
		]]>
	</select>
	
	<select id="getCompanyInfo" resultType="hashMap" parameterType="hashMap">
		<![CDATA[
			SELECT MEMBER_ID, PASSWORD, MEMBER_NAME,
				TRIM(PHONE) AS PHONE,
				TRIM(MOBILE) AS MOBILE,
				EMAIL, B.DATA_CODE_NAME, A.COM_NAME, A.LOGIN_YN,
				AREA, GRADE
			 FROM GY_MEMBER A,GY_CODE B
			WHERE A.GRADE = B.DATA_CODE
			  AND B.CODE_TYPE = '04'
			  AND A.MEMBER_ID = #{member_id}
		]]>
	</select>
	
	<update id="updateCompanyInfo" parameterType="hashMap">
		UPDATE GY_MEMBER
		SET
			PASSWORD = #{password}
			, MEMBER_NAME = #{member_name}
			, COM_NAME = #{com_name}
			, COM_CEO = #{com_ceo}
			, EMAIL = #{email}
			, PHONE = #{phone}
			, MOBILE = #{mobile}
			, AREA = #{area}
			, YEAR = #{year}
		WHERE
			MEMBER_ID = #{member_id}
	</update>
	
	
	<select id="getCompanyRepairCnt" resultType="int" parameterType="hashMap">
		<![CDATA[
			SELECT COUNT(*)
			 from gy_light_repair a, gy_light_repair_part b 
  where a.repair_no = b.repair_no 
  and b.company_id = 'yang' 
     and to_char(b.last_update, 'yyyy-mm-dd') between #{sDate} and #{eDate}    
		]]>
			<if test="repair_cd != null and repair_cd != '' ">
				AND A.REPAIR_CD = #{repair_cd}	
			</if>
	</select>
	
	<select id="getCompanyRepairList" resultType="hashMap" parameterType="hashMap">
		<![CDATA[
			  SELECT A.REPAIR_NO
			        , SUBSTR(A.REPAIR_NO,1,6)||'-'||SUBSTR(A.REPAIR_NO,9,2) AS REPAIR_NO2 
			        , A.REPAIR_CD
			        , CASE WHEN A.REPAIR_CD = '1' AND A.LIGHT_GUBUN = '1' THEN '보안등/불편신고'
			               WHEN A.REPAIR_CD = '1' AND A.LIGHT_GUBUN = '2' THEN '가로등/불편신고'
			               WHEN A.REPAIR_CD = '2' AND A.LIGHT_GUBUN = '1' THEN '보안등/신설요청'
			               WHEN A.REPAIR_CD = '2' AND A.LIGHT_GUBUN = '2' THEN '가로등/신설요청'
			               WHEN A.REPAIR_CD = '3' AND A.LIGHT_GUBUN = '1' THEN '보안등/이설요청'
			               WHEN A.REPAIR_CD = '3' AND A.LIGHT_GUBUN = '2' THEN '가로등/이설요청'
			               WHEN A.REPAIR_CD = '4' AND A.LIGHT_GUBUN = '1' THEN '보안등/철거요청'
			               WHEN A.REPAIR_CD = '4' AND A.LIGHT_GUBUN = '2' THEN '가로등/철거요청'
			               END  AS REPAIR_NAME
			        , A.PASSWORD
			        , A.LIGHT_NO
			        , TO_CHAR(A.NOTICE_DATE, 'YYYY.MM.DD') AS NOTICE_DATE
			        , A.NOTICE_NAME
			        , A.LOCATION
			        , A.TROUBLE_CD
			        , A.TROUBLE_CD_ETC
			        , A.TROUBLE_DETAIL
			        , CASE WHEN INFORM_METHOD = '01'
							   				THEN PHONE
							   				WHEN INFORM_METHOD = '02'
							   				THEN MOBILE
							   				WHEN INFORM_METHOD = '04'
							   				THEN ''
							   				END AS PHONE
			        , A.EMAIL
			        , A.INFORM_METHOD
			        , A.PROGRESS_STATUS
			        , A.SATI_RATING
			        , TO_CHAR(A.MODIFY_DATE, 'YYYY.MM.DD') AS MODIFY_DATE
			        , A.DONG
			        , A.REMARK
			        , (SELECT DATA_CODE_NAME FROM GY_CODE WHERE CODE_TYPE='03' AND A.PROGRESS_STATUS = DATA_CODE) AS PROGRESS_NAME
			        , (SELECT DATA_CODE_NAME FROM GY_CODE WHERE CODE_TYPE='28' AND DATA_CODE = A.REMARK) AS REMARK_NAME
			        , A.LIGHT_GUBUN
			        , SUBSTR(B.REPAIR_DATE,1,4)||'.'||SUBSTR(B.REPAIR_DATE,5,2)||'.'||SUBSTR(B.REPAIR_DATE,7,2)  AS REPAIR_DATE
   FROM GY_LIGHT_REPAIR A, GY_LIGHT_REPAIR_PART B 
  WHERE A.REPAIR_NO = B.REPAIR_NO 
  AND B.COMPANY_ID = 'yang' 
     AND TO_CHAR(B.LAST_UPDATE, 'YYYY-MM-DD') BETWEEN #{sDate} and #{eDate}     
			]]>
					<if test="sch_repair_cd != null and sch_repair_cd != '' ">
						AND A.REPAIR_CD = #{sch_repair_cd}	
					</if>
					<if test="sch_where1 == 1 ">
						AND A.LIGHT_NO LIKE '%'|| #{sch_where3}	||'%'
					</if>
					<if test="sch_where1 == 5 ">
						AND A.NOTICE_NAME LIKE '%'|| #{sch_where3}	||'%'
					</if>
					<if test="sch_where1 eq 4 ">
						AND A.PROGRESS_STATUS LIKE '%'|| #{sch_where2}	||'%'
					</if>
					<if test="sch_where1 == 6 ">
						AND A.DONG LIKE '%'|| #{sch_where2} ||'%'	
					</if>
					<if test="sch_where1 == 2 ">
						AND A.LIGHT_NO LIKE '%'|| #{sch_where2} ||'%'	
					</if>
			<![CDATA[
				ORDER BY A.REPAIR_NO DESC
			
		]]>
	</select>
	
	
	
	<select id="getCompanyRepairDetail" resultType="hashMap" parameterType="hashMap">
		<![CDATA[
	  	 SELECT A.REPAIR_NO
	  	      , A.REPAIR_DATE 
              , A.REPAIR_PARTS
              , A.REPAIR_DESC
              , A.LIGHT_NO
              , B.LOCATION
              , A.COMPANY_ID
              , B.REPAIR_GUBUN
              , CASE WHEN B.REPAIR_GUBUN = '1' THEN '교체(변경)'
                     WHEN B.REPAIR_GUBUN = '2' THEN '이설'
                     WHEN B.REPAIR_GUBUN = '3' THEN '철거'
                     WHEN B.REPAIR_GUBUN = '4' THEN '보수'
                     WHEN B.REPAIR_GUBUN = '5' THEN '신설'
                     END AS REPAIR_GUBUN_NM
              , B.REPAIR_BIGO
              , TO_CHAR( A.LAST_UPDATE ,'YYYY.MM.DD HH24:MI:SS') AS LAST_UPDATE
              , A.PHOTO1
              , A.PHOTO2
              , A.PHOTO3
              , A.ETC_PHOTO1
              , A.ETC_PHOTO2
              , A.ETC_PHOTO3
              , B.INFORM_METHOD
              , F_GY_DATA_CODE_NM('02',B.INFORM_METHOD ) AS INFORM_NM
              , B.MOBILE
              , B.EMAIL
              , B.PROGRESS_STATUS               
              , F_GY_DATA_CODE_NM('03',B.PROGRESS_STATUS ) AS PROGRESS_STATUS_NM
              , B.NOTICE_NAME
              , B.LIGHT_GUBUN
              , TO_CHAR( B.MODIFY_DATE ,'YYYY.MM.DD HH24:MI:SS') AS MODIFY_DATE
              , B.REPAIR_CD
              , F_GY_DATA_CODE_NM('14',B.REPAIR_CD ) AS REPAIR_NM
              , F_GY_DATA_CODE_NM('01', TROUBLE_CD) AS TROUBLE_NM
              , B.TROUBLE_DETAIL
              , B.PHONE
              , B.REMARK
              , B.REMARK_ETC
              , B.DONG
              , (SELECT COM_NAME FROM GY_MEMBER WHERE MEMBER_ID = A.COMPANY_ID) AS COM_NAME  
              , F_GY_DATA_CODE_NM('10', (select lamp2_cd from gy_light where light_no = a.light_no)) as lamp2_cd_nm 
		      , F_GY_DATA_CODE_NM('11', (select lamp3_cd from gy_light where light_no = a.light_no)) as lamp3_cd_nm   
		      , F_GY_DATA_CODE_NM('08', (select stand_cd from gy_light where light_no = a.light_no)) as stand_cd_nm  
		      , F_GY_DATA_CODE_NM('13', (select onoff_cd from gy_light where light_no = a.light_no)) as onoff_cd_nm 
   		      , COALESCE((SELECT ETC FROM GY_LIGHT WHERE LIGHT_NO = A.LIGHT_NO),'') AS ETC 
    		  , COALESCE((SELECT LAMP1_CD_ETC FROM GY_LIGHT WHERE LIGHT_NO = A.LIGHT_NO),'') AS LAMP1_CD_ETC 
		   FROM GY_LIGHT_REPAIR_PART A, GY_LIGHT_REPAIR B 
		  WHERE A.REPAIR_NO = B.REPAIR_NO 
		    AND A.REPAIR_NO = #{repairNo}
			]]>
	</select>
	
	
	<select id="getCompanyRepairExcelList" resultType="hashMap" parameterType="hashMap">
		<![CDATA[
				SELECT SUBSTR(A.REPAIR_NO,1,6)||'-'||SUBSTR(A.REPAIR_NO,9,2) AS  "접수번호"
			        , CASE WHEN A.REPAIR_CD = '1' AND A.LIGHT_GUBUN = '1' THEN '보안등/불편신고'
			               WHEN A.REPAIR_CD = '1' AND A.LIGHT_GUBUN = '2' THEN '가로등/불편신고'
			               WHEN A.REPAIR_CD = '2' AND A.LIGHT_GUBUN = '1' THEN '보안등/신설요청'
			               WHEN A.REPAIR_CD = '2' AND A.LIGHT_GUBUN = '2' THEN '가로등/신설요청'
			               WHEN A.REPAIR_CD = '3' AND A.LIGHT_GUBUN = '1' THEN '보안등/이설요청'
			               WHEN A.REPAIR_CD = '3' AND A.LIGHT_GUBUN = '2' THEN '가로등/이설요청'
			               WHEN A.REPAIR_CD = '4' AND A.LIGHT_GUBUN = '1' THEN '보안등/철거요청'
			               WHEN A.REPAIR_CD = '4' AND A.LIGHT_GUBUN = '2' THEN '가로등/철거요청'
			               END  AS "민원종류"
			        , A.LIGHT_NO AS "관리번호"
			        , A.NOTICE_NAME AS "신고인"
			        , CASE WHEN INFORM_METHOD = '01'
							   				THEN PHONE
							   				WHEN INFORM_METHOD = '02'
							   				THEN MOBILE
							   				WHEN INFORM_METHOD = '04'
							   				THEN ''
							   				END AS "전화번호"
			        , TO_CHAR(A.NOTICE_DATE, 'YYYY.MM.DD') AS "접수일"
			        , SUBSTR(B.REPAIR_DATE,1,4)||'.'||SUBSTR(B.REPAIR_DATE,5,2)||'.'||SUBSTR(B.REPAIR_DATE,7,2)  AS "보수일"
			        , F_GY_DATA_CODE_NM('03', PROGRESS_STATUS) AS "처리상황"
   FROM GY_LIGHT_REPAIR A, GY_LIGHT_REPAIR_PART B 
  WHERE A.REPAIR_NO = B.REPAIR_NO 
  AND B.COMPANY_ID = 'yang' 
     AND TO_CHAR(B.LAST_UPDATE, 'YYYY-MM-DD') BETWEEN #{sDate} and #{eDate}     
			]]>
					<if test="repair_cd != null and repair_cd != '' ">
						AND A.REPAIR_CD = #{repair_cd}	
					</if>
			<![CDATA[
				ORDER BY A.REPAIR_NO
			
		]]>
	</select>
	
	
	<update id="updateCompanyRepair" parameterType="hashMap">
		update gy_light_repair set
			progress_status = #{progress_status}
			, repair_gubun = #{repair_gubun}
			, repair_bigo = #{repair_bigo}	
		WHERE
			repair_no = #{repairNo}
	</update>
	
	<update id="updateCompanyRepairPart" parameterType="hashMap">
		update gy_light_repair_part set
			  repair_date = #{repair_date}
			, repair_desc = #{repair_desc}
			, photo1 = #{photo1}
			, photo2 = #{photo2}
			, photo3 = #{photo3}
			, last_update = now()
		WHERE
			repair_no = #{repairNo}
	</update>
	
	
</mapper>